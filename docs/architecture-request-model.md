# 请求反馈模式

## 概述

针对请求参数复杂，请求频率长尾类型的数据，我们采取了**请求反馈模式**。

当长尾请求抵达预言机时，预言机将发出一个**数据请求**并发射**数据请求事件**。

喂价节点程序会监听来自预言机发射的事件，分析数据需求，启动工作流程，从接口、数据库或其他数据源将所需数据更新至**”聚合器合约“**中。

**聚合器合约**将根据**数据聚合模型**将数据整理后更新至预言机。同时根据数据请求参数中的**回调合约地址**及**回调函数方法**将数据返回给**消费者合约**。

## 客户端合约

客户端合约是一个能够被继承的智能合约（父合约），消费者合约通过继承客户端合约来获取**预言机合约**中的数据。

消费者合约继承客户端合约后，可以直接调用该合约预置的方法，对预言机合约发起数据请求。

客户端发送的请求包含想要的**预言机合约地址**、**请求项**以及**回调函数**等全部成功循环所需数据。

请求将发送到预言机合约中。

## 预言机合约

预言机合约接受聚合器合约更新的最新数据。

预言机同时接受来自客户端合约的请求。

处理请求的过程中会发射**数据请求事件**，一个链下的**节点程序**监听到该事件后，将其所需数据发布到**聚合器合约**中。最终数据被存入**预言机合约**，且执行请求中的**回调方法**，继续完成原DApp合约既定功能。

## 链下预言机节点

节点具备2方面功能：

- 监听数据请求事件
- 对聚合合约进行喂价

预言机节点程序监听到**数据请求事件**后，从数据库中，或第三方接口服务中获取到最新数据，验证后存入请求对应的预言机合约中。

节点程序可同时为多个数据预言机提供服务。